/*
 * TSAC_control.c
 *
 *  Created on: Oct 18, 2025
 *      Author: Egquus
 */
/* Includes ------------------------------------------------------------------*/
#include "TSAC_control.h"
/* USER CODE BEGIN 0 */
/*Includes*/
#include "main.h"
#include "can.h"

/* Variables */
extern volatile uint8_t BMS_state;

extern uint8_t CAN1_exe;
extern uint8_t CAN2_exe;
extern uint8_t TxData[8];
extern uint32_t TxMailbox;

extern CAN_TxHeaderTypeDef TxHeader;
extern CAN_RxHeaderTypeDef RxHeader;

uint8_t LED_GN_state = 0;
uint8_t LED_YW_state = 0;
uint8_t LED_RD_state = 0;

uint8_t data_shit[8];
uint8_t config_watch = 1;

extern uint8_t tim2_100ms = 0;
extern uint8_t tim2_1ms = 0;
/*Functions*/

void TSAC_control(){

/*________________________________________________________________________________________________________*/
	CAN_transceive(&hcan1, &CAN1_exe, TxData);

	void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim){
	    if (htim->Instance == TIM2) {
	        // 100 ms-Zyklus
	        if (tim2_100ms >= 100) {
	            if (HAL_CAN_GetTxMailboxesFreeLevel(&hcan1) > 0) {
	                if (HAL_CAN_AddTxMessage(&hcan1, &TxHeader, TxData, &TxMailbox) != HAL_OK) {
	                    BMS_state = 1;
	                    Error_Handler();

	                }

	                LED_GN_state++;
	            }

	            tim2_100ms = 0;
	        }
	        // 1 ms-Zyklus
	        if(tim2_100ms >= TIM2){
	        	HAL_GPIO_TogglePin(GPIOC, LED_GN_Pin);
	        }

	        tim2_100ms++;
	        tim2_1ms++;
	    }
	}
/*________________________________________________________________________________________________________*/
	Slave_control(config_watch, data_shit);

/*________________________________________________________________________________________________________*/
	USB_control(data_shit);
}

/* USER CODE END 0 */

/*----------------------------------------------------------------------------*/
