/*
 * LTC6811.c
 *
 *  Created on: Nov 8, 2025
 *      Author: racin
 */


#include <stdint.h>
#include "LTC6811.h"
#include <string.h>
#include <stdio.h>
#include <main.h>
#include <math.h>
#include "define.h"
/*@brief 6811 conversion command variables
 */
uint8_t ADCV[2]; //!< Cell Voltage conversion command.
uint8_t ADAX[2]; //!< GPIO conversion command.
uint8_t CVST[2]; //!< Cell Voltage selftest command
uint8_t AXST[2]; //!< GPIO selftest command
uint8_t CLRAUX[2]; //clear Auxiliary register

uint8_t wakeup = 0x00;

void LTC6811_initialize()
{
  set_adc(MD_NORMAL, DCP_DISABLED, CELL_CH_ALL, AUX_CH_ALL, CHST_ITMP);
  //set_selftest(MD_NORMAL, ST_1);
}

void wakeup_idle()
{
	HAL_GPIO_WritePin(SPI3_CS_GPIO_Port, SPI3_CS_Pin, GPIO_PIN_RESET);
	HAL_SPI_Transmit(&hspi3, &wakeup, 1, 1);
	HAL_GPIO_WritePin(SPI3_CS_GPIO_Port, SPI3_CS_Pin, GPIO_PIN_SET);
}
/*!******************************************************************************************************************
 \brief Maps  global ADC control variables to the appropriate control bytes for each of the different ADC commands

@param[in] int MD The adc conversion mode
@param[in] int DCP Controls if Discharge is permitted during cell conversions
@param[in] int CH Determines which cells are measured during an ADC conversion command
@param[in] int CHG Determines which GPIO channels are measured during Auxiliary conversion command
Command Code: \n
			|command	|  10   |   9   |   8   |   7   |   6   |   5   |   4   |   3   |   2   |   1   |   0   |
			|-----------|-------|-------|-------|-------|-------|-------|-------|-------|-------|-------|-------|
			|ADCV:	    |   0   |   1   | MD[1] | MD[2] |   1   |   1   |  DCP  |   0   | CH[2] | CH[1] | CH[0] |
			|ADAX:	    |   1   |   0   | MD[1] | MD[2] |   1   |   1   |  DCP  |   0   | CHG[2]| CHG[1]| CHG[0]|
			|ADSTAT:    |   1   |   0   | MD[1] | MD[2] |   1   |   1   |   0   |   1   |CHST[2]|CHST[1]|CHST[0]|
 ******************************************************************************************************************/
void set_adc(uint8_t MD, uint8_t DCP, uint8_t CH, uint8_t CHG, uint8_t CHST)
{
  uint8_t md_bits;

  md_bits = (MD & 0x02) >> 1;
  ADCV[0] = md_bits | 0x02;
  md_bits = (MD & 0x01) << 7;
  ADCV[1] = md_bits | 0x60 | (DCP << 4) | CH;

  md_bits = (MD & 0x02) >> 1;
  ADAX[0] = md_bits | 0x04;
  md_bits = (MD & 0x01) << 7;
  ADAX[1] = md_bits | 0x60 | CHG;

  CLRAUX[0] = 0x0E;
  CLRAUX[1] = 0x12;

  /*
    md_bits = (MD & 0x02) >> 1;
    ADSTAT[0] = md_bits | 0x04;
    md_bits = (MD & 0x01) << 7;
    ADSTAT[1] = md_bits | 0x68 | CHST;
    */
}

